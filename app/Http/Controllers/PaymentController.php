<?php

namespace App\Http\Controllers;

use App\Http\Controllers\DonationController;
use GlobalPayments\Api\Entities\Address;
use GlobalPayments\Api\Entities\Enums\AddressType;
use GlobalPayments\Api\ServiceConfigs\Gateways\GpEcomConfig;
use GlobalPayments\Api\HostedPaymentConfig;
use GlobalPayments\Api\Entities\HostedPaymentData;
use GlobalPayments\Api\Entities\Enums\HppVersion;
use GlobalPayments\Api\Entities\Exceptions\ApiException;
use GlobalPayments\Api\Services\HostedService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class PaymentController extends Controller
{
    public function hppRequestDonate(Request $request)
    {
        // Laravel Logger
        $alumniLogger = Log::channel('daily');
        // dd('Checkpoint 1');
        
        if ($request->has('amount')) {
            // dd('Checkpoint 2');
            $payment_amount = (float) $request->input('amount');
            if ($payment_amount == 0) {
                $payment_amount = 10.00;
            }
        
            // Configure client, request, and HPP settings
            $config = new GpEcomConfig();
            if (env('paymentStatus') == 'DEVELOPMENT') {
                $config->merchantId = env('HPP_DEV_MERCHANT_ID');
                $config->accountId = env('HPP_DEV_DONATE_ACCOUNT_ID');
                $config->sharedSecret = env('HPP_DEV_DONATE_SHARED_SECRET');
                $config->serviceUrl = env('HPP_DEV_SERVICE_URL');
            } else {
                $config->merchantId = env('HPP_LIVE_MERCHANT_ID');
                $config->accountId = env('HPP_LIVE_DONATE_ACCOUNT_ID');
                $config->sharedSecret = env('HPP_LIVE_DONATE_SHARED_SECRET');
                $config->serviceUrl = env('HPP_LIVE_SERVICE_URL');
            }
            //  dd($config);
            $config->hostedPaymentConfig = new HostedPaymentConfig();
            $config->hostedPaymentConfig->version = HppVersion::VERSION_2;
            $service = new HostedService($config);
            
            $countriesArr = array( "BD" => array ( "name" => "Bangladesh", "phone" => "880" ), "BE" => array ( "name" => "Belgium", "phone" => "32" ), "BF" => array ( "name" => "Burkina Faso", "phone" => "226" ), "BG" => array ( "name" => "Bulgaria", "phone" => "359" ), "BA" => array ( "name" => "Bosnia and Herzegovina", "phone" => "387" ), "BB" => array ( "name" => "Barbados", "phone" => "1246" ), "WF" => array ( "name" => "Wallis and Futuna", "phone" => "681" ), "BL" => array ( "name" => "Saint Barthelemy", "phone" => "590" ), "BM" => array ( "name" => "Bermuda", "phone" => "1441" ), "BN" => array ( "name" => "Brunei", "phone" => "673" ), "BO" => array ( "name" => "Bolivia", "phone" => "591" ), "BH" => array ( "name" => "Bahrain", "phone" => "973" ), "BI" => array ( "name" => "Burundi", "phone" => "257" ), "BJ" => array ( "name" => "Benin", "phone" => "229" ), "BT" => array ( "name" => "Bhutan", "phone" => "975" ), "JM" => array ( "name" => "Jamaica", "phone" => "1876" ), "BV" => array ( "name" => "Bouvet Island", "phone" => "" ), "BW" => array ( "name" => "Botswana", "phone" => "267" ), "WS" => array ( "name" => "Samoa", "phone" => "685" ), "BQ" => array ( "name" => "Bonaire, Saint Eustatius and Saba ", "phone" => "599" ), "BR" => array ( "name" => "Brazil", "phone" => "55" ), "BS" => array ( "name" => "Bahamas", "phone" => "1242" ), "JE" => array ( "name" => "Jersey", "phone" => "44" ), "BY" => array ( "name" => "Belarus", "phone" => "375" ), "BZ" => array ( "name" => "Belize", "phone" => "501" ), "RU" => array ( "name" => "Russia", "phone" => "7" ), "RW" => array ( "name" => "Rwanda", "phone" => "250" ), "RS" => array ( "name" => "Serbia", "phone" => "381" ), "TL" => array ( "name" => "East Timor", "phone" => "670" ), "RE" => array ( "name" => "Reunion", "phone" => "262" ), "TM" => array ( "name" => "Turkmenistan", "phone" => "993" ), "TJ" => array ( "name" => "Tajikistan", "phone" => "992" ), "RO" => array ( "name" => "Romania", "phone" => "40" ), "TK" => array ( "name" => "Tokelau", "phone" => "690" ), "GW" => array ( "name" => "Guinea-Bissau", "phone" => "245" ), "GU" => array ( "name" => "Guam", "phone" => "1671" ), "GT" => array ( "name" => "Guatemala", "phone" => "502" ), "GS" => array ( "name" => "South Georgia and the South Sandwich Islands", "phone" => "" ), "GR" => array ( "name" => "Greece", "phone" => "30" ), "GQ" => array ( "name" => "Equatorial Guinea", "phone" => "240" ), "GP" => array ( "name" => "Guadeloupe", "phone" => "590" ), "JP" => array ( "name" => "Japan", "phone" => "81" ), "GY" => array ( "name" => "Guyana", "phone" => "592" ), "GG" => array ( "name" => "Guernsey", "phone" => "44" ), "GF" => array ( "name" => "French Guiana", "phone" => "594" ), "GE" => array ( "name" => "Georgia", "phone" => "995" ), "GD" => array ( "name" => "Grenada", "phone" => "1473" ), "GB" => array ( "name" => "United Kingdom", "phone" => "44" ), "GA" => array ( "name" => "Gabon", "phone" => "241" ), "SV" => array ( "name" => "El Salvador", "phone" => "503" ), "GN" => array ( "name" => "Guinea", "phone" => "224" ), "GM" => array ( "name" => "Gambia", "phone" => "220" ), "GL" => array ( "name" => "Greenland", "phone" => "299" ), "GI" => array ( "name" => "Gibraltar", "phone" => "350" ), "GH" => array ( "name" => "Ghana", "phone" => "233" ), "OM" => array ( "name" => "Oman", "phone" => "968" ), "TN" => array ( "name" => "Tunisia", "phone" => "216" ), "JO" => array ( "name" => "Jordan", "phone" => "962" ), "HR" => array ( "name" => "Croatia", "phone" => "385" ), "HT" => array ( "name" => "Haiti", "phone" => "509" ), "HU" => array ( "name" => "Hungary", "phone" => "36" ), "HK" => array ( "name" => "Hong Kong", "phone" => "852" ), "HN" => array ( "name" => "Honduras", "phone" => "504" ), "HM" => array ( "name" => "Heard Island and McDonald Islands", "phone" => " " ), "VE" => array ( "name" => "Venezuela", "phone" => "58" ), "PR" => array ( "name" => "Puerto Rico", "phone" => "1" ), "PS" => array ( "name" => "Palestinian Territory", "phone" => "970" ), "PW" => array ( "name" => "Palau", "phone" => "680" ), "PT" => array ( "name" => "Portugal", "phone" => "351" ), "SJ" => array ( "name" => "Svalbard and Jan Mayen", "phone" => "47" ), "PY" => array ( "name" => "Paraguay", "phone" => "595" ), "IQ" => array ( "name" => "Iraq", "phone" => "964" ), "PA" => array ( "name" => "Panama", "phone" => "507" ), "PF" => array ( "name" => "French Polynesia", "phone" => "689" ), "PG" => array ( "name" => "Papua New Guinea", "phone" => "675" ), "PE" => array ( "name" => "Peru", "phone" => "51" ), "PK" => array ( "name" => "Pakistan", "phone" => "92" ), "PH" => array ( "name" => "Philippines", "phone" => "63" ), "PN" => array ( "name" => "Pitcairn", "phone" => "870" ), "PL" => array ( "name" => "Poland", "phone" => "48" ), "PM" => array ( "name" => "Saint Pierre and Miquelon", "phone" => "508" ), "ZM" => array ( "name" => "Zambia", "phone" => "260" ), "EH" => array ( "name" => "Western Sahara", "phone" => "212" ), "EE" => array ( "name" => "Estonia", "phone" => "372" ), "EG" => array ( "name" => "Egypt", "phone" => "20" ), "ZA" => array ( "name" => "South Africa", "phone" => "27" ), "EC" => array ( "name" => "Ecuador", "phone" => "593" ), "IT" => array ( "name" => "Italy", "phone" => "39" ), "VN" => array ( "name" => "Vietnam", "phone" => "84" ), "SB" => array ( "name" => "Solomon Islands", "phone" => "677" ), "ET" => array ( "name" => "Ethiopia", "phone" => "251" ), "SO" => array ( "name" => "Somalia", "phone" => "252" ), "ZW" => array ( "name" => "Zimbabwe", "phone" => "263" ), "SA" => array ( "name" => "Saudi Arabia", "phone" => "966" ), "ES" => array ( "name" => "Spain", "phone" => "34" ), "ER" => array ( "name" => "Eritrea", "phone" => "291" ), "ME" => array ( "name" => "Montenegro", "phone" => "382" ), "MD" => array ( "name" => "Moldova", "phone" => "373" ), "MG" => array ( "name" => "Madagascar", "phone" => "261" ), "MF" => array ( "name" => "Saint Martin", "phone" => "590" ), "MA" => array ( "name" => "Morocco", "phone" => "212" ), "MC" => array ( "name" => "Monaco", "phone" => "377" ), "UZ" => array ( "name" => "Uzbekistan", "phone" => "998" ), "MM" => array ( "name" => "Myanmar", "phone" => "95" ), "ML" => array ( "name" => "Mali", "phone" => "223" ), "MO" => array ( "name" => "Macao", "phone" => "853" ), "MN" => array ( "name" => "Mongolia", "phone" => "976" ), "MH" => array ( "name" => "Marshall Islands", "phone" => "692" ), "MK" => array ( "name" => "Macedonia", "phone" => "389" ), "MU" => array ( "name" => "Mauritius", "phone" => "230" ), "MT" => array ( "name" => "Malta", "phone" => "356" ), "MW" => array ( "name" => "Malawi", "phone" => "265" ), "MV" => array ( "name" => "Maldives", "phone" => "960" ), "MQ" => array ( "name" => "Martinique", "phone" => "596" ), "MP" => array ( "name" => "Northern Mariana Islands", "phone" => "1670" ), "MS" => array ( "name" => "Montserrat", "phone" => "1664" ), "MR" => array ( "name" => "Mauritania", "phone" => "222" ), "IM" => array ( "name" => "Isle of Man", "phone" => "44" ), "UG" => array ( "name" => "Uganda", "phone" => "256" ), "TZ" => array ( "name" => "Tanzania", "phone" => "255" ), "MY" => array ( "name" => "Malaysia", "phone" => "60" ), "MX" => array ( "name" => "Mexico", "phone" => "52" ), "IL" => array ( "name" => "Israel", "phone" => "972" ), "FR" => array ( "name" => "France", "phone" => "33" ), "IO" => array ( "name" => "British Indian Ocean Territory", "phone" => "246" ), "SH" => array ( "name" => "Saint Helena", "phone" => "290" ), "FI" => array ( "name" => "Finland", "phone" => "358" ), "FJ" => array ( "name" => "Fiji", "phone" => "679" ), "FK" => array ( "name" => "Falkland Islands", "phone" => "500" ), "FM" => array ( "name" => "Micronesia", "phone" => "691" ), "FO" => array ( "name" => "Faroe Islands", "phone" => "298" ), "NI" => array ( "name" => "Nicaragua", "phone" => "505" ), "NL" => array ( "name" => "Netherlands", "phone" => "31" ), "NO" => array ( "name" => "Norway", "phone" => "47" ), "NA" => array ( "name" => "Namibia", "phone" => "264" ), "VU" => array ( "name" => "Vanuatu", "phone" => "678" ), "NC" => array ( "name" => "New Caledonia", "phone" => "687" ), "NE" => array ( "name" => "Niger", "phone" => "227" ), "NF" => array ( "name" => "Norfolk Island", "phone" => "672" ), "NG" => array ( "name" => "Nigeria", "phone" => "234" ), "NZ" => array ( "name" => "New Zealand", "phone" => "64" ), "NP" => array ( "name" => "Nepal", "phone" => "977" ), "NR" => array ( "name" => "Nauru", "phone" => "674" ), "NU" => array ( "name" => "Niue", "phone" => "683" ), "CK" => array ( "name" => "Cook Islands", "phone" => "682" ), "XK" => array ( "name" => "Kosovo", "phone" => "" ), "CI" => array ( "name" => "Ivory Coast", "phone" => "225" ), "CH" => array ( "name" => "Switzerland", "phone" => "41" ), "CO" => array ( "name" => "Colombia", "phone" => "57" ), "CN" => array ( "name" => "China", "phone" => "86" ), "CM" => array ( "name" => "Cameroon", "phone" => "237" ), "CL" => array ( "name" => "Chile", "phone" => "56" ), "CC" => array ( "name" => "Cocos Islands", "phone" => "61" ), "CA" => array ( "name" => "Canada", "phone" => "1" ), "CG" => array ( "name" => "Republic of the Congo", "phone" => "242" ), "CF" => array ( "name" => "Central African Republic", "phone" => "236" ), "CD" => array ( "name" => "Democratic Republic of the Congo", "phone" => "243" ), "CZ" => array ( "name" => "Czech Republic", "phone" => "420" ), "CY" => array ( "name" => "Cyprus", "phone" => "357" ), "CX" => array ( "name" => "Christmas Island", "phone" => "61" ), "CR" => array ( "name" => "Costa Rica", "phone" => "506" ), "CW" => array ( "name" => "Curacao", "phone" => "599" ), "CV" => array ( "name" => "Cape Verde", "phone" => "238" ), "CU" => array ( "name" => "Cuba", "phone" => "53" ), "SZ" => array ( "name" => "Swaziland", "phone" => "268" ), "SY" => array ( "name" => "Syria", "phone" => "963" ), "SX" => array ( "name" => "Sint Maarten", "phone" => "599" ), "KG" => array ( "name" => "Kyrgyzstan", "phone" => "996" ), "KE" => array ( "name" => "Kenya", "phone" => "254" ), "SS" => array ( "name" => "South Sudan", "phone" => "211" ), "SR" => array ( "name" => "Suriname", "phone" => "597" ), "KI" => array ( "name" => "Kiribati", "phone" => "686" ), "KH" => array ( "name" => "Cambodia", "phone" => "855" ), "KN" => array ( "name" => "Saint Kitts and Nevis", "phone" => "1869" ), "KM" => array ( "name" => "Comoros", "phone" => "269" ), "ST" => array ( "name" => "Sao Tome and Principe", "phone" => "239" ), "SK" => array ( "name" => "Slovakia", "phone" => "421" ), "KR" => array ( "name" => "South Korea", "phone" => "82" ), "SI" => array ( "name" => "Slovenia", "phone" => "386" ), "KP" => array ( "name" => "North Korea", "phone" => "850" ), "KW" => array ( "name" => "Kuwait", "phone" => "965" ), "SN" => array ( "name" => "Senegal", "phone" => "221" ), "SM" => array ( "name" => "San Marino", "phone" => "378" ), "SL" => array ( "name" => "Sierra Leone", "phone" => "232" ), "SC" => array ( "name" => "Seychelles", "phone" => "248" ), "KZ" => array ( "name" => "Kazakhstan", "phone" => "7" ), "KY" => array ( "name" => "Cayman Islands", "phone" => "1345" ), "SG" => array ( "name" => "Singapore", "phone" => "65" ), "SE" => array ( "name" => "Sweden", "phone" => "46" ), "SD" => array ( "name" => "Sudan", "phone" => "249" ), "DO" => array ( "name" => "Dominican Republic", "phone" => "1809" ), "DM" => array ( "name" => "Dominica", "phone" => "1767" ), "DJ" => array ( "name" => "Djibouti", "phone" => "253" ), "DK" => array ( "name" => "Denmark", "phone" => "45" ), "VG" => array ( "name" => "British Virgin Islands", "phone" => "1284" ), "DE" => array ( "name" => "Germany", "phone" => "49" ), "YE" => array ( "name" => "Yemen", "phone" => "967" ), "DZ" => array ( "name" => "Algeria", "phone" => "213" ), "US" => array ( "name" => "United States", "phone" => "1" ), "UY" => array ( "name" => "Uruguay", "phone" => "598" ), "YT" => array ( "name" => "Mayotte", "phone" => "262" ), "UM" => array ( "name" => "United States Minor Outlying Islands", "phone" => "1" ), "LB" => array ( "name" => "Lebanon", "phone" => "961" ), "LC" => array ( "name" => "Saint Lucia", "phone" => "1758" ), "LA" => array ( "name" => "Laos", "phone" => "856" ), "TV" => array ( "name" => "Tuvalu", "phone" => "688" ), "TW" => array ( "name" => "Taiwan", "phone" => "886" ), "TT" => array ( "name" => "Trinidad and Tobago", "phone" => "1868" ), "TR" => array ( "name" => "Turkey", "phone" => "90" ), "LK" => array ( "name" => "Sri Lanka", "phone" => "94" ), "LI" => array ( "name" => "Liechtenstein", "phone" => "423" ), "LV" => array ( "name" => "Latvia", "phone" => "371" ), "TO" => array ( "name" => "Tonga", "phone" => "676" ), "LT" => array ( "name" => "Lithuania", "phone" => "370" ), "LU" => array ( "name" => "Luxembourg", "phone" => "352" ), "LR" => array ( "name" => "Liberia", "phone" => "231" ), "LS" => array ( "name" => "Lesotho", "phone" => "266" ), "TH" => array ( "name" => "Thailand", "phone" => "66" ), "TF" => array ( "name" => "French Southern Territories", "phone" => "" ), "TG" => array ( "name" => "Togo", "phone" => "228" ), "TD" => array ( "name" => "Chad", "phone" => "235" ), "TC" => array ( "name" => "Turks and Caicos Islands", "phone" => "1649" ), "LY" => array ( "name" => "Libya", "phone" => "218" ), "VA" => array ( "name" => "Vatican", "phone" => "379" ), "VC" => array ( "name" => "Saint Vincent and the Grenadines", "phone" => "1784" ), "AE" => array ( "name" => "United Arab Emirates", "phone" => "971" ), "AD" => array ( "name" => "Andorra", "phone" => "376" ), "AG" => array ( "name" => "Antigua and Barbuda", "phone" => "1268" ), "AF" => array ( "name" => "Afghanistan", "phone" => "93" ), "AI" => array ( "name" => "Anguilla", "phone" => "1264" ), "VI" => array ( "name" => "U.S. Virgin Islands", "phone" => "1340" ), "IS" => array ( "name" => "Iceland", "phone" => "354" ), "IR" => array ( "name" => "Iran", "phone" => "98" ), "AM" => array ( "name" => "Armenia", "phone" => "374" ), "AL" => array ( "name" => "Albania", "phone" => "355" ), "AO" => array ( "name" => "Angola", "phone" => "244" ), "AQ" => array ( "name" => "Antarctica", "phone" => "" ), "AS" => array ( "name" => "American Samoa", "phone" => "1684" ), "AR" => array ( "name" => "Argentina", "phone" => "54" ), "AU" => array ( "name" => "Australia", "phone" => "61" ), "AT" => array ( "name" => "Austria", "phone" => "43" ), "AW" => array ( "name" => "Aruba", "phone" => "297" ), "IN" => array ( "name" => "India", "phone" => "91" ), "AX" => array ( "name" => "Aland Islands", "phone" => "358" ), "AZ" => array ( "name" => "Azerbaijan", "phone" => "994" ), "IE" => array ( "name" => "Ireland", "phone" => "353" ), "ID" => array ( "name" => "Indonesia", "phone" => "62" ), "UA" => array ( "name" => "Ukraine", "phone" => "380" ), "QA" => array ( "name" => "Qatar", "phone" => "974" ), "MZ" => array ( "name" => "Mozambique", "phone" => "258" ));
            
            $countryDetails = ["code" => "", "phone" => ""];
            foreach ($countriesArr as $key => $val) {
                if ($val['name'] == session('country')) {
                    $countryDetails['code'] = $key;
                    $countryDetails['phone'] = $val['phone'];
                }
            }
            // dd($countryDetails);
            $hostedPaymentData = new HostedPaymentData();
            $hostedPaymentData->customerEmail = session('email');
            if (strlen(session('mobile')) > 0) {
                $hostedPaymentData->customerPhoneMobile = (strlen($countryDetails['phone']) > 0) ? $countryDetails['phone'].'|'.session('mobile') : session('mobile');
            }
            $hostedPaymentData->addressesMatch = false;
        
            $streetAddressFullStr = preg_replace("/,([\s])+/",",", session('address'));
            $streetArr = array_pad(explode(",", $streetAddressFullStr), 3, "");
        
            $billingAddress = new Address();
            $billingAddress->streetAddress1 = preg_replace("/[^A-Za-z0-9 ]/", ' ', $streetArr[0]);
            $billingAddress->streetAddress2 = preg_replace("/[^A-Za-z0-9 ]/", ' ', $streetArr[1]);
            $billingAddress->streetAddress3 = preg_replace("/[^A-Za-z0-9 ]/", ' ', $streetArr[2]);
            $billingAddress->city = preg_replace("/[^A-Za-z0-9 ]/", ' ', session('town'));
            $billingAddress->postalCode = session('postcode');
            $billingAddress->country = $countryDetails['code'];

            try {
                $hppJson = $service->charge($payment_amount)
                    ->withCurrency("GBP")
                    ->withHostedPaymentData($hostedPaymentData)
                    ->withAddress($billingAddress, AddressType::BILLING)
                    ->withClientTransactionId(session('qmul_order_id'))
                    ->serialize();

                    $alumniLogger->info('Payment initialized. HPP JSON data: ' . $hppJson);

                    // Return a response indicating successful payment initialization
                    return response()->json($hppJson);
                } catch (ApiException $e) {
                    // Log the error and return an error response
                    $alumniLogger->error('Payment initialization failed. Error: ' . $e->getMessage());
                    return response()->json(['error' => 'Payment initialization failed'], 500);
                }
        }   
    }

    public function hppRequest(Request $request)
    {
        // Laravel Logger
        $alumniLogger = Log::channel('daily');
        // dd('Checkpoint 1');
        
        if ($request->has('amount')) {
            // dd('Checkpoint 2');
            $payment_amount = (float) $request->input('amount');
            if ($payment_amount == 0) {
                $payment_amount = 10.00;
            }
        
            // Configure client, request, and HPP settings
            $config = new GpEcomConfig();
            if (env('paymentStatus') == 'DEVELOPMENT') {
                $config->merchantId = env('HPP_DEV_MERCHANT_ID');
                $config->accountId = env('HPP_DEV_DONATE_ACCOUNT_ID');
                $config->sharedSecret = env('HPP_DEV_DONATE_SHARED_SECRET');
                $config->serviceUrl = env('HPP_DEV_SERVICE_URL');
            } else {
                $config->merchantId = env('HPP_LIVE_MERCHANT_ID');
                $config->accountId = env('HPP_LIVE_DONATE_ACCOUNT_ID');
                $config->sharedSecret = env('HPP_LIVE_DONATE_SHARED_SECRET');
                $config->serviceUrl = env('HPP_LIVE_SERVICE_URL');
            }
            //  dd($config);
            $config->hostedPaymentConfig = new HostedPaymentConfig();
            $config->hostedPaymentConfig->version = HppVersion::VERSION_2;
            $service = new HostedService($config);
            
            $countriesArr = array( "BD" => array ( "name" => "Bangladesh", "phone" => "880" ), "BE" => array ( "name" => "Belgium", "phone" => "32" ), "BF" => array ( "name" => "Burkina Faso", "phone" => "226" ), "BG" => array ( "name" => "Bulgaria", "phone" => "359" ), "BA" => array ( "name" => "Bosnia and Herzegovina", "phone" => "387" ), "BB" => array ( "name" => "Barbados", "phone" => "1246" ), "WF" => array ( "name" => "Wallis and Futuna", "phone" => "681" ), "BL" => array ( "name" => "Saint Barthelemy", "phone" => "590" ), "BM" => array ( "name" => "Bermuda", "phone" => "1441" ), "BN" => array ( "name" => "Brunei", "phone" => "673" ), "BO" => array ( "name" => "Bolivia", "phone" => "591" ), "BH" => array ( "name" => "Bahrain", "phone" => "973" ), "BI" => array ( "name" => "Burundi", "phone" => "257" ), "BJ" => array ( "name" => "Benin", "phone" => "229" ), "BT" => array ( "name" => "Bhutan", "phone" => "975" ), "JM" => array ( "name" => "Jamaica", "phone" => "1876" ), "BV" => array ( "name" => "Bouvet Island", "phone" => "" ), "BW" => array ( "name" => "Botswana", "phone" => "267" ), "WS" => array ( "name" => "Samoa", "phone" => "685" ), "BQ" => array ( "name" => "Bonaire, Saint Eustatius and Saba ", "phone" => "599" ), "BR" => array ( "name" => "Brazil", "phone" => "55" ), "BS" => array ( "name" => "Bahamas", "phone" => "1242" ), "JE" => array ( "name" => "Jersey", "phone" => "44" ), "BY" => array ( "name" => "Belarus", "phone" => "375" ), "BZ" => array ( "name" => "Belize", "phone" => "501" ), "RU" => array ( "name" => "Russia", "phone" => "7" ), "RW" => array ( "name" => "Rwanda", "phone" => "250" ), "RS" => array ( "name" => "Serbia", "phone" => "381" ), "TL" => array ( "name" => "East Timor", "phone" => "670" ), "RE" => array ( "name" => "Reunion", "phone" => "262" ), "TM" => array ( "name" => "Turkmenistan", "phone" => "993" ), "TJ" => array ( "name" => "Tajikistan", "phone" => "992" ), "RO" => array ( "name" => "Romania", "phone" => "40" ), "TK" => array ( "name" => "Tokelau", "phone" => "690" ), "GW" => array ( "name" => "Guinea-Bissau", "phone" => "245" ), "GU" => array ( "name" => "Guam", "phone" => "1671" ), "GT" => array ( "name" => "Guatemala", "phone" => "502" ), "GS" => array ( "name" => "South Georgia and the South Sandwich Islands", "phone" => "" ), "GR" => array ( "name" => "Greece", "phone" => "30" ), "GQ" => array ( "name" => "Equatorial Guinea", "phone" => "240" ), "GP" => array ( "name" => "Guadeloupe", "phone" => "590" ), "JP" => array ( "name" => "Japan", "phone" => "81" ), "GY" => array ( "name" => "Guyana", "phone" => "592" ), "GG" => array ( "name" => "Guernsey", "phone" => "44" ), "GF" => array ( "name" => "French Guiana", "phone" => "594" ), "GE" => array ( "name" => "Georgia", "phone" => "995" ), "GD" => array ( "name" => "Grenada", "phone" => "1473" ), "GB" => array ( "name" => "United Kingdom", "phone" => "44" ), "GA" => array ( "name" => "Gabon", "phone" => "241" ), "SV" => array ( "name" => "El Salvador", "phone" => "503" ), "GN" => array ( "name" => "Guinea", "phone" => "224" ), "GM" => array ( "name" => "Gambia", "phone" => "220" ), "GL" => array ( "name" => "Greenland", "phone" => "299" ), "GI" => array ( "name" => "Gibraltar", "phone" => "350" ), "GH" => array ( "name" => "Ghana", "phone" => "233" ), "OM" => array ( "name" => "Oman", "phone" => "968" ), "TN" => array ( "name" => "Tunisia", "phone" => "216" ), "JO" => array ( "name" => "Jordan", "phone" => "962" ), "HR" => array ( "name" => "Croatia", "phone" => "385" ), "HT" => array ( "name" => "Haiti", "phone" => "509" ), "HU" => array ( "name" => "Hungary", "phone" => "36" ), "HK" => array ( "name" => "Hong Kong", "phone" => "852" ), "HN" => array ( "name" => "Honduras", "phone" => "504" ), "HM" => array ( "name" => "Heard Island and McDonald Islands", "phone" => " " ), "VE" => array ( "name" => "Venezuela", "phone" => "58" ), "PR" => array ( "name" => "Puerto Rico", "phone" => "1" ), "PS" => array ( "name" => "Palestinian Territory", "phone" => "970" ), "PW" => array ( "name" => "Palau", "phone" => "680" ), "PT" => array ( "name" => "Portugal", "phone" => "351" ), "SJ" => array ( "name" => "Svalbard and Jan Mayen", "phone" => "47" ), "PY" => array ( "name" => "Paraguay", "phone" => "595" ), "IQ" => array ( "name" => "Iraq", "phone" => "964" ), "PA" => array ( "name" => "Panama", "phone" => "507" ), "PF" => array ( "name" => "French Polynesia", "phone" => "689" ), "PG" => array ( "name" => "Papua New Guinea", "phone" => "675" ), "PE" => array ( "name" => "Peru", "phone" => "51" ), "PK" => array ( "name" => "Pakistan", "phone" => "92" ), "PH" => array ( "name" => "Philippines", "phone" => "63" ), "PN" => array ( "name" => "Pitcairn", "phone" => "870" ), "PL" => array ( "name" => "Poland", "phone" => "48" ), "PM" => array ( "name" => "Saint Pierre and Miquelon", "phone" => "508" ), "ZM" => array ( "name" => "Zambia", "phone" => "260" ), "EH" => array ( "name" => "Western Sahara", "phone" => "212" ), "EE" => array ( "name" => "Estonia", "phone" => "372" ), "EG" => array ( "name" => "Egypt", "phone" => "20" ), "ZA" => array ( "name" => "South Africa", "phone" => "27" ), "EC" => array ( "name" => "Ecuador", "phone" => "593" ), "IT" => array ( "name" => "Italy", "phone" => "39" ), "VN" => array ( "name" => "Vietnam", "phone" => "84" ), "SB" => array ( "name" => "Solomon Islands", "phone" => "677" ), "ET" => array ( "name" => "Ethiopia", "phone" => "251" ), "SO" => array ( "name" => "Somalia", "phone" => "252" ), "ZW" => array ( "name" => "Zimbabwe", "phone" => "263" ), "SA" => array ( "name" => "Saudi Arabia", "phone" => "966" ), "ES" => array ( "name" => "Spain", "phone" => "34" ), "ER" => array ( "name" => "Eritrea", "phone" => "291" ), "ME" => array ( "name" => "Montenegro", "phone" => "382" ), "MD" => array ( "name" => "Moldova", "phone" => "373" ), "MG" => array ( "name" => "Madagascar", "phone" => "261" ), "MF" => array ( "name" => "Saint Martin", "phone" => "590" ), "MA" => array ( "name" => "Morocco", "phone" => "212" ), "MC" => array ( "name" => "Monaco", "phone" => "377" ), "UZ" => array ( "name" => "Uzbekistan", "phone" => "998" ), "MM" => array ( "name" => "Myanmar", "phone" => "95" ), "ML" => array ( "name" => "Mali", "phone" => "223" ), "MO" => array ( "name" => "Macao", "phone" => "853" ), "MN" => array ( "name" => "Mongolia", "phone" => "976" ), "MH" => array ( "name" => "Marshall Islands", "phone" => "692" ), "MK" => array ( "name" => "Macedonia", "phone" => "389" ), "MU" => array ( "name" => "Mauritius", "phone" => "230" ), "MT" => array ( "name" => "Malta", "phone" => "356" ), "MW" => array ( "name" => "Malawi", "phone" => "265" ), "MV" => array ( "name" => "Maldives", "phone" => "960" ), "MQ" => array ( "name" => "Martinique", "phone" => "596" ), "MP" => array ( "name" => "Northern Mariana Islands", "phone" => "1670" ), "MS" => array ( "name" => "Montserrat", "phone" => "1664" ), "MR" => array ( "name" => "Mauritania", "phone" => "222" ), "IM" => array ( "name" => "Isle of Man", "phone" => "44" ), "UG" => array ( "name" => "Uganda", "phone" => "256" ), "TZ" => array ( "name" => "Tanzania", "phone" => "255" ), "MY" => array ( "name" => "Malaysia", "phone" => "60" ), "MX" => array ( "name" => "Mexico", "phone" => "52" ), "IL" => array ( "name" => "Israel", "phone" => "972" ), "FR" => array ( "name" => "France", "phone" => "33" ), "IO" => array ( "name" => "British Indian Ocean Territory", "phone" => "246" ), "SH" => array ( "name" => "Saint Helena", "phone" => "290" ), "FI" => array ( "name" => "Finland", "phone" => "358" ), "FJ" => array ( "name" => "Fiji", "phone" => "679" ), "FK" => array ( "name" => "Falkland Islands", "phone" => "500" ), "FM" => array ( "name" => "Micronesia", "phone" => "691" ), "FO" => array ( "name" => "Faroe Islands", "phone" => "298" ), "NI" => array ( "name" => "Nicaragua", "phone" => "505" ), "NL" => array ( "name" => "Netherlands", "phone" => "31" ), "NO" => array ( "name" => "Norway", "phone" => "47" ), "NA" => array ( "name" => "Namibia", "phone" => "264" ), "VU" => array ( "name" => "Vanuatu", "phone" => "678" ), "NC" => array ( "name" => "New Caledonia", "phone" => "687" ), "NE" => array ( "name" => "Niger", "phone" => "227" ), "NF" => array ( "name" => "Norfolk Island", "phone" => "672" ), "NG" => array ( "name" => "Nigeria", "phone" => "234" ), "NZ" => array ( "name" => "New Zealand", "phone" => "64" ), "NP" => array ( "name" => "Nepal", "phone" => "977" ), "NR" => array ( "name" => "Nauru", "phone" => "674" ), "NU" => array ( "name" => "Niue", "phone" => "683" ), "CK" => array ( "name" => "Cook Islands", "phone" => "682" ), "XK" => array ( "name" => "Kosovo", "phone" => "" ), "CI" => array ( "name" => "Ivory Coast", "phone" => "225" ), "CH" => array ( "name" => "Switzerland", "phone" => "41" ), "CO" => array ( "name" => "Colombia", "phone" => "57" ), "CN" => array ( "name" => "China", "phone" => "86" ), "CM" => array ( "name" => "Cameroon", "phone" => "237" ), "CL" => array ( "name" => "Chile", "phone" => "56" ), "CC" => array ( "name" => "Cocos Islands", "phone" => "61" ), "CA" => array ( "name" => "Canada", "phone" => "1" ), "CG" => array ( "name" => "Republic of the Congo", "phone" => "242" ), "CF" => array ( "name" => "Central African Republic", "phone" => "236" ), "CD" => array ( "name" => "Democratic Republic of the Congo", "phone" => "243" ), "CZ" => array ( "name" => "Czech Republic", "phone" => "420" ), "CY" => array ( "name" => "Cyprus", "phone" => "357" ), "CX" => array ( "name" => "Christmas Island", "phone" => "61" ), "CR" => array ( "name" => "Costa Rica", "phone" => "506" ), "CW" => array ( "name" => "Curacao", "phone" => "599" ), "CV" => array ( "name" => "Cape Verde", "phone" => "238" ), "CU" => array ( "name" => "Cuba", "phone" => "53" ), "SZ" => array ( "name" => "Swaziland", "phone" => "268" ), "SY" => array ( "name" => "Syria", "phone" => "963" ), "SX" => array ( "name" => "Sint Maarten", "phone" => "599" ), "KG" => array ( "name" => "Kyrgyzstan", "phone" => "996" ), "KE" => array ( "name" => "Kenya", "phone" => "254" ), "SS" => array ( "name" => "South Sudan", "phone" => "211" ), "SR" => array ( "name" => "Suriname", "phone" => "597" ), "KI" => array ( "name" => "Kiribati", "phone" => "686" ), "KH" => array ( "name" => "Cambodia", "phone" => "855" ), "KN" => array ( "name" => "Saint Kitts and Nevis", "phone" => "1869" ), "KM" => array ( "name" => "Comoros", "phone" => "269" ), "ST" => array ( "name" => "Sao Tome and Principe", "phone" => "239" ), "SK" => array ( "name" => "Slovakia", "phone" => "421" ), "KR" => array ( "name" => "South Korea", "phone" => "82" ), "SI" => array ( "name" => "Slovenia", "phone" => "386" ), "KP" => array ( "name" => "North Korea", "phone" => "850" ), "KW" => array ( "name" => "Kuwait", "phone" => "965" ), "SN" => array ( "name" => "Senegal", "phone" => "221" ), "SM" => array ( "name" => "San Marino", "phone" => "378" ), "SL" => array ( "name" => "Sierra Leone", "phone" => "232" ), "SC" => array ( "name" => "Seychelles", "phone" => "248" ), "KZ" => array ( "name" => "Kazakhstan", "phone" => "7" ), "KY" => array ( "name" => "Cayman Islands", "phone" => "1345" ), "SG" => array ( "name" => "Singapore", "phone" => "65" ), "SE" => array ( "name" => "Sweden", "phone" => "46" ), "SD" => array ( "name" => "Sudan", "phone" => "249" ), "DO" => array ( "name" => "Dominican Republic", "phone" => "1809" ), "DM" => array ( "name" => "Dominica", "phone" => "1767" ), "DJ" => array ( "name" => "Djibouti", "phone" => "253" ), "DK" => array ( "name" => "Denmark", "phone" => "45" ), "VG" => array ( "name" => "British Virgin Islands", "phone" => "1284" ), "DE" => array ( "name" => "Germany", "phone" => "49" ), "YE" => array ( "name" => "Yemen", "phone" => "967" ), "DZ" => array ( "name" => "Algeria", "phone" => "213" ), "US" => array ( "name" => "United States", "phone" => "1" ), "UY" => array ( "name" => "Uruguay", "phone" => "598" ), "YT" => array ( "name" => "Mayotte", "phone" => "262" ), "UM" => array ( "name" => "United States Minor Outlying Islands", "phone" => "1" ), "LB" => array ( "name" => "Lebanon", "phone" => "961" ), "LC" => array ( "name" => "Saint Lucia", "phone" => "1758" ), "LA" => array ( "name" => "Laos", "phone" => "856" ), "TV" => array ( "name" => "Tuvalu", "phone" => "688" ), "TW" => array ( "name" => "Taiwan", "phone" => "886" ), "TT" => array ( "name" => "Trinidad and Tobago", "phone" => "1868" ), "TR" => array ( "name" => "Turkey", "phone" => "90" ), "LK" => array ( "name" => "Sri Lanka", "phone" => "94" ), "LI" => array ( "name" => "Liechtenstein", "phone" => "423" ), "LV" => array ( "name" => "Latvia", "phone" => "371" ), "TO" => array ( "name" => "Tonga", "phone" => "676" ), "LT" => array ( "name" => "Lithuania", "phone" => "370" ), "LU" => array ( "name" => "Luxembourg", "phone" => "352" ), "LR" => array ( "name" => "Liberia", "phone" => "231" ), "LS" => array ( "name" => "Lesotho", "phone" => "266" ), "TH" => array ( "name" => "Thailand", "phone" => "66" ), "TF" => array ( "name" => "French Southern Territories", "phone" => "" ), "TG" => array ( "name" => "Togo", "phone" => "228" ), "TD" => array ( "name" => "Chad", "phone" => "235" ), "TC" => array ( "name" => "Turks and Caicos Islands", "phone" => "1649" ), "LY" => array ( "name" => "Libya", "phone" => "218" ), "VA" => array ( "name" => "Vatican", "phone" => "379" ), "VC" => array ( "name" => "Saint Vincent and the Grenadines", "phone" => "1784" ), "AE" => array ( "name" => "United Arab Emirates", "phone" => "971" ), "AD" => array ( "name" => "Andorra", "phone" => "376" ), "AG" => array ( "name" => "Antigua and Barbuda", "phone" => "1268" ), "AF" => array ( "name" => "Afghanistan", "phone" => "93" ), "AI" => array ( "name" => "Anguilla", "phone" => "1264" ), "VI" => array ( "name" => "U.S. Virgin Islands", "phone" => "1340" ), "IS" => array ( "name" => "Iceland", "phone" => "354" ), "IR" => array ( "name" => "Iran", "phone" => "98" ), "AM" => array ( "name" => "Armenia", "phone" => "374" ), "AL" => array ( "name" => "Albania", "phone" => "355" ), "AO" => array ( "name" => "Angola", "phone" => "244" ), "AQ" => array ( "name" => "Antarctica", "phone" => "" ), "AS" => array ( "name" => "American Samoa", "phone" => "1684" ), "AR" => array ( "name" => "Argentina", "phone" => "54" ), "AU" => array ( "name" => "Australia", "phone" => "61" ), "AT" => array ( "name" => "Austria", "phone" => "43" ), "AW" => array ( "name" => "Aruba", "phone" => "297" ), "IN" => array ( "name" => "India", "phone" => "91" ), "AX" => array ( "name" => "Aland Islands", "phone" => "358" ), "AZ" => array ( "name" => "Azerbaijan", "phone" => "994" ), "IE" => array ( "name" => "Ireland", "phone" => "353" ), "ID" => array ( "name" => "Indonesia", "phone" => "62" ), "UA" => array ( "name" => "Ukraine", "phone" => "380" ), "QA" => array ( "name" => "Qatar", "phone" => "974" ), "MZ" => array ( "name" => "Mozambique", "phone" => "258" ));
            
            $countryDetails = ["code" => "", "phone" => ""];
            foreach ($countriesArr as $key => $val) {
                if ($val['name'] == session('country')) {
                    $countryDetails['code'] = $key;
                    $countryDetails['phone'] = $val['phone'];
                }
            }
            // dd($countryDetails);
            $hostedPaymentData = new HostedPaymentData();
            $hostedPaymentData->customerEmail = session('email');
            if (strlen(session('mobile')) > 0) {
                $hostedPaymentData->customerPhoneMobile = (strlen($countryDetails['phone']) > 0) ? $countryDetails['phone'].'|'.session('mobile') : session('mobile');
            }
            $hostedPaymentData->addressesMatch = false;
        
            $streetAddressFullStr = preg_replace("/,([\s])+/",",", session('address'));
            $streetArr = array_pad(explode(",", $streetAddressFullStr), 3, "");
        
            $billingAddress = new Address();
            $billingAddress->streetAddress1 = preg_replace("/[^A-Za-z0-9 ]/", ' ', $streetArr[0]);
            $billingAddress->streetAddress2 = preg_replace("/[^A-Za-z0-9 ]/", ' ', $streetArr[1]);
            $billingAddress->streetAddress3 = preg_replace("/[^A-Za-z0-9 ]/", ' ', $streetArr[2]);
            $billingAddress->city = preg_replace("/[^A-Za-z0-9 ]/", ' ', session('town'));
            $billingAddress->postalCode = session('postcode');
            $billingAddress->country = $countryDetails['code'];

            try {
                $hppJson = $service->charge($payment_amount)
                    ->withCurrency("GBP")
                    ->withHostedPaymentData($hostedPaymentData)
                    ->withAddress($billingAddress, AddressType::BILLING)
                    ->withClientTransactionId(session('qmul_order_id'))
                    ->serialize();

                    $alumniLogger->info('Payment initialized. HPP JSON data: ' . $hppJson);
                    // Return a response indicating successful payment initialization
                    return response()->json($hppJson);
                } catch (ApiException $e) {
                    // Log the error and return an error response
                    $alumniLogger->error('Payment initialization failed. Error: ' . $e->getMessage());
                    return response()->json(['error' => 'Payment initialization failed'], 500);
                }
        }   
    }
}
